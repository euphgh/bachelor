% !TEX root = ../main.tex
\chapter{技术背景及研究动机}

\section{RISC-V虚拟化扩展}
RISC-V的虚拟化扩展需要添加的硬件功能大致可分为特权控制和虚拟内存两大部分。
在特权控制方面，主要新增了3种特权模式、12条特权指令、23个控制状态寄存器以及虚拟化相关的4种中断和6种异常。
在虚拟内存方面，首先定义了第二阶段地址翻译的概念，
同时添加了上述部分的控制状态寄存器、虚拟内存管理指令和异常，为程序员提供了管理第二阶段地址翻译的手段。

\paragraph{特权控制}
特权等级在未支持虚拟化扩展时只有机器模式（M-mode）、监管模式（S-mode）和用户模式（U-mode）。
分别对应标准体系结构中运行引导程序，操作系统和用户程序的机器状态。
然而，在虚拟化扩展下，原本的监管模式被改成虚拟机管理模式（HS-mode），对应于虚拟机管理程序的层级。
还新增了虚拟监管模式（VS-mode）和虚拟用户模式（VU-mode），对应于虚拟机和虚拟机下的用户态程序。
此外还保留了原始的用户模式，对应于Type2虚拟机监管系统下的宿主操作系统的用户程序。
例如在Linux KVM中，需要先启动宿主Linux操作系统，此时处理器运行在虚拟机管理模式下。
在宿主操作系统除了具有启动虚拟机的功能，还具有一般Linux操作系统的所有能力。
在未启动虚拟机时运行的用户态程序时，处理器就在用户模式下，而不是虚拟用户模式。

控制管理寄存器（Control Status Register）是RISC-V处理器中的一组特殊寄存器，
用于控制处理器的行为和存储处理器的状态信息。
这些寄存器包含了处理器的核心控制逻辑和状态信息，可以被软件访问和操作。
虚拟化扩展下，控制管理寄存器的一个最主要的变化是添加了一套在虚拟监管模式下使用的，
用于处理虚拟机中的异常自陷的流程的寄存器，比如配置自陷地址的vstvec、保存异常指令地址的vsepc。
分离管理系统和虚拟机中使用的配置寄存器，能够使得虚拟机中出现异常时可以自己处理，不必自陷到虚拟机管理系统中。
另一个变化是添加了一些虚拟机管理系统使用寄存器，用于配置管理系统可以捕获的虚拟机内执行的特殊指令（hstatus），
虚拟机的中断注入和委托（hedeleg、hideleg、hgeip、hgeie）等。
因此，在中断异常的种类方面，原始的监管模式下所有的中断被虚拟机管理模式和虚拟监管模式各复制一份，
虚拟机管理模式还需要添加一个虚拟机外部中断，用于实现虚拟机直通中断。

最后一部分是虚拟机管理模式下的特权指令和新增的页错误异常，为程序员提供管理虚拟地址翻译的方法。
在未实现虚拟化扩展下的SFENCE.VMA指令用于同步页表数据结构，相对的，虚拟化扩展下新增了HFENCE.VVMA和HFENCE.GVMA，
用于第二阶段地址翻译的页表数据结构的同步。
同时新增了HLV.width, HLVX.HU/WU, HSV.width指令，为虚拟机管理系统提供了读取虚拟机内存的方法。

\paragraph{虚拟内存}
第二阶段地址翻译是虚拟化扩展提出的重要概念，是指在虚拟化环境中进行的地址转换过程的第二个阶段。
在传统的虚拟地址翻译机制中，虚拟地址（Virtual Address）只需要经过一次多级页表翻译即可成为物理地址（Physical Address）访问实际的内存。
在第二段地址翻译开启时，虚拟机操作系统会对内部的虚拟地址进行一次页表翻译，
即将虚拟机虚拟地址（Guest Virtual Address）翻译成虚拟机物理地址（Guest Physical Address）。
此时处理器还需要再进行一次多级地址翻译将虚拟机物理地址翻译成物理地址才能够访问内存。
以经典的三级页表为例，未开启第二阶段翻译时，比如虚拟机管理程序运行时，
最多需要访问内存三次，获取三个页表项（Page Table Entry）即可完成地址翻译。
但在开启后，比如在虚拟监管模式下运行虚拟机，每次访存获取下一级页表之前，都需要再经过三级页表翻译。
换言之，为了获得虚拟机的虚地址所对应的物理地址，最多需要12次的内存访问。

为了管理第二阶段的地址翻译的相关信息，处理器需要提供相应的指令和控制状态寄存器用于配置。
关于控制状态寄存器，首先是第二阶段地址翻译的叶目录的根地址，保存在hgapt的寄存器中，对应于保存第一阶段地址翻译相关信息的sapt寄存器。
其次，在地址翻译的过程中不免要进行访存和权限检查，如果失败会导致处理器产生一个页错误的异常，用于操作系统进行替换或者进一步的诊断。
因此，虚拟化扩展新增了虚拟机物理页错误的异常，对应于第二阶段地址翻译时的权限检查失败或者访存错误。
自然的，虚拟机物理页错误异常的处理程序需要触发异常的虚拟机物理地址进行诊断，htval和mtval2寄存器被新增用于在异常触发时保存虚拟机物理地址。
可以预见，处理器的流水线内部同样需要空间保存错误地址。
特别对于取指时触发的虚拟机页错误异常，需要该指令携带地址直至退休，这对流水线中的存储部件来说是一种较大的面积开销。
对于虚拟内存管理指令，在上文也有提及。用于同步第二阶段页表翻译单元数据结构的HFENCE.VVMA和HFENCE.GVMA指令。
一个简单的实现可以是无效处理器内有关第二阶段地址翻译的所有缓冲。
关于HLV.width, HLVX.HU/WU, HSV.width指令，实质是在虚拟机管理模式下开启第二阶段地址翻译进行访存

\section{虚拟化扩展实现案例}
虚拟化扩展的相关工作介绍

\section{“香山”处理器的内存管理单元}
介绍未实现虚拟化扩展的虚拟内存单元，方便后续对比

\section{处理器设计的调试及评测平台}
介绍本文中出现的调试和评测平台

调试：逻辑分析仪、仿真工具（verilator、iverilog），辅之以模拟器（QEMU、Spike）和差分测试方法，更精确定位错误现场。

评测：硬件部署在FPGA中进行原型验证

也有通过FPGA加速仿真的方式（REMU），能够更高效的得到波形进行调试